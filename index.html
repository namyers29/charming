<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HTML5 Flipbook (22 Pages) ‚Äî Updated Layout</title>
  <style>
    :root {
      --bg: #0b0c10;
      --ink: #eaf0f6;
      --accent: #57a5ff;
      --page-w: 500px;
      --page-h: 500px;
      --shadow: 0 30px 80px rgba(0,0,0,.45), 0 8px 24px rgba(0,0,0,.5);
      --focus: 0 0 0 3px rgba(87,165,255,.6);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      background: radial-gradient(1200px 700px at 50% -10%, #1a2333 0, #0b0c10 60%, #050607 100%);
      color: var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      display: grid;
      place-items: center;
      overflow: hidden;
    }

    /* Stage stacks the book and controls */
    .stage {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px; /* controls close to bottom of book */
    }

    .viewport {
      height: var(--page-h);
      perspective: 2000px;
      position: relative;
      outline: none;
    }

    .book {
      position: absolute;
      inset: 0;
      transform-style: preserve-3d;
    }

    .page {
      position: absolute; top: 0; left: 0;
      width: var(--page-w); height: var(--page-h); overflow: hidden;
      border-radius: 8px; box-shadow: var(--shadow);
      transform-origin: left center;
      backface-visibility: hidden;
      background: #0c0f16;
    }

    .page.right { left: var(--page-w); transform-origin: right center; }

    .page img {
      width: var(--page-w);
      height: var(--page-h);
      object-fit: cover;
      display: block;
    }

    .curling {
      transition: transform 0.8s cubic-bezier(.77,.2,.05,1.0);
      will-change: transform;
      z-index: 10;
      pointer-events: none;
      transform: rotateY(0deg);
    }

    .ui {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 6px;
    }

    .nav {
      border: 1px solid #2b3345;
      background: rgba(15,20,32,.9);
      color: var(--ink);
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.06);
    }

    .nav:focus-visible { box-shadow: var(--focus); outline: none; }
    .nav:disabled { opacity: .5; cursor: default; }
    .nav:hover:not(:disabled) { background: rgba(20,26,42,.95); border-color: #3a4560; }

    .counter {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.1);
      background: rgba(10,12,18,.6);
      font-variant-numeric: tabular-nums;
    }

    .audio-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 2px;
    }

    .audio-controls .nav {
      font-size: 14px;
      padding: 8px 10px;
    }

    .audio-label {
      opacity: .85;
      font-size: 14px;
    }

    @media (prefers-reduced-motion: reduce) {
      .curling { transition: none !important; }
    }
  </style>
</head>
<body>
  <div class="stage">
    <div class="viewport" id="viewport" aria-live="polite" tabindex="0"></div>

    <!-- NAVIGATION CONTROLS (above audio) -->
    <div class="ui" id="ui" role="toolbar" aria-label="Flipbook navigation">
      <button class="nav" id="prevBtn" aria-label="Previous page">‚üµ</button>
      <div class="counter" id="counter" aria-live="polite">1 / 1</div>
      <button class="nav" id="nextBtn" aria-label="Next page">‚ü∂</button>
      <button class="nav" id="fsBtn" aria-label="Fullscreen" aria-pressed="false">‚õ∂ Fullscreen</button>
    </div>

    <!-- AUDIO CONTROLS (below nav) -->
    <div class="audio-controls" aria-label="Background audio controls">
      <span class="audio-label">Audio:</span>
      <button class="nav" id="muteBtn" aria-label="Mute">üîá Mute</button>
      <button class="nav" id="pauseBtn" aria-label="Pause">‚è∏Ô∏è Pause</button>
    </div>
  </div>

  <audio id="bgm" preload="auto"></audio>

  <script>
    const BASE = 'https://namyers29.github.io/charming/img/';
    const DEFAULT_PAGES = Array.from({length: 22}, (_, i) => {
      const n = String(i + 1).padStart(2, '0');
      return `${BASE}${n}.png`;
    });

    const FALLBACK_IMG = 'https://namyers29.github.io/charming/img/fallback.png';
    const AUDIO_SOURCES = ['audio/bgm.mp3'];

    let pages = [...DEFAULT_PAGES];
    let spreadIndex = 0;
    let forwardFlips = 0;
    let bgmStarted = false;
    let isAnimating = false;

    const REDUCED_MOTION = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const viewport = document.getElementById('viewport');
    const counterEl = document.getElementById('counter');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const fsBtn = document.getElementById('fsBtn');
    const bgm = document.getElementById('bgm');
    const muteBtn = document.getElementById('muteBtn');
    const pauseBtn = document.getElementById('pauseBtn');

    function setAudioSources(urls){
      if (!bgm) return;
      bgm.innerHTML = '';
      urls.forEach(u => {
        const s = document.createElement('source');
        s.src = u;
        s.type = 'audio/mpeg';
        bgm.appendChild(s);
      });
      bgm.load();
    }

    if (bgm){
      setAudioSources(AUDIO_SOURCES);
      bgm.loop = false;
      bgm.volume = 1.0;
      bgm.addEventListener('error', () => {
        const current = bgm.currentSrc;
        const idx = AUDIO_SOURCES.findIndex(u => current.includes(u));
        const nextIdx = idx + 1;
        if (nextIdx < AUDIO_SOURCES.length) setAudioSources([AUDIO_SOURCES[nextIdx]]);
      });
    }

    function getCssNumber(varName){
      const v = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
      return parseFloat(v.replace('px','')) || 0;
    }
    let PAGE_W = getCssNumber('--page-w') || 500;
    let PAGE_H = getCssNumber('--page-h') || 500;

    function totalInteriorSpreads(){ return Math.ceil(Math.max(0, (pages.length - 2)) / 2); }
    function maxSpread(){ return totalInteriorSpreads() + 1; }
    function isCoverView(){ return spreadIndex === 0; }
    function isBackView(){ return spreadIndex === maxSpread(); }

    function setViewportSize(){
      PAGE_W = getCssNumber('--page-w') || PAGE_W;
      PAGE_H = getCssNumber('--page-h') || PAGE_H;
      viewport.style.width = (isCoverView() || isBackView()) ? PAGE_W + 'px' : (PAGE_W * 2) + 'px';
      viewport.style.height = PAGE_H + 'px';
    }

    function updateCounter(){
      if (!counterEl) return;
      const totalViews = maxSpread() + 1;
      const viewNumber = Math.min(spreadIndex + 1, totalViews);
      counterEl.textContent = `${viewNumber} / ${Math.max(totalViews,1)}`;
      prevBtn.disabled = spreadIndex <= 0 || isAnimating;
      nextBtn.disabled = spreadIndex >= maxSpread() || isAnimating;
    }

    function createPage(url, isRight=false, altText=''){
      const p = document.createElement('div');
      p.className = 'page' + (isRight ? ' right' : '');
      const img = document.createElement('img');
      img.src = url;
      img.alt = altText || '';
      img.loading = 'lazy';
      img.decoding = 'async';
      img.onerror = () => { if (FALLBACK_IMG) img.src = FALLBACK_IMG; };
      p.appendChild(img);
      return p;
    }

    function render(){
      viewport.innerHTML = '';
      const book = document.createElement('div');
      book.className = 'book';
      viewport.appendChild(book);
      setViewportSize();

      if (!pages.length){
        const empty = document.createElement('div');
        empty.className = 'page';
        empty.style.display = 'grid';
        empty.style.placeItems = 'center';
        empty.innerHTML = '<div style="opacity:.8;text-align:center">No pages configured.</div>';
        book.appendChild(empty);
        updateCounter();
        return;
      }

      if (isCoverView()){
        book.appendChild(createPage(pages[0], false, 'Front Cover'));
      } else if (isBackView()){
        book.appendChild(createPage(pages[pages.length-1], false, 'Back Cover'));
      } else {
        const leftIdx = 1 + (spreadIndex-1)*2;
        const rightIdx = leftIdx + 1;
        book.appendChild(createPage(pages[leftIdx], false, `Page ${leftIdx+1}`));
        book.appendChild(createPage(pages[rightIdx], true, `Page ${rightIdx+1}`));
      }
      updateCounter();
    }

    function animateFlip(forward){
      if (isAnimating) return;
      if (REDUCED_MOTION){ render(); return; }
      isAnimating = true;
      const book = viewport.querySelector('.book');
      if(!book){ isAnimating = false; return; }

      const leaf = document.createElement('div');
      leaf.className = 'page curling';
      if (forward){
        leaf.style.left = isCoverView() ? '0' : PAGE_W + 'px';
        leaf.style.transformOrigin = 'right center';
      } else {
        leaf.style.left = '0';
        leaf.style.transformOrigin = 'left center';
      }
      leaf.innerHTML = `<img src="${pages[0]}" alt="Turning page">`;
      book.appendChild(leaf);

      requestAnimationFrame(()=>requestAnimationFrame(()=>{
        leaf.style.transform = `rotateY(${forward ? -180 : 180}deg)`;
      }));

      leaf.addEventListener('transitionend', ()=>{ 
        isAnimating = false; 
        render(); 
      }, { once:true });
    }

    function flip(direction){
      if (isAnimating) return;
      if (direction === 1 && spreadIndex < maxSpread()){
        animateFlip(true);
        spreadIndex++;
        forwardFlips++;
        if (!bgmStarted && forwardFlips === 2 && bgm){
          bgm.play().then(()=>{ bgmStarted = true; updateAudioButtons(); }).catch(()=>{});
        }
      } else if (direction === -1 && spreadIndex > 0){
        animateFlip(false);
        spreadIndex--;
      }
      updateCounter();
    }

    document.addEventListener('keydown', e=>{
      if (e.key==='ArrowRight'||e.key==='d') flip(1);
      if (e.key==='ArrowLeft'||e.key==='a') flip(-1);
    });
    prevBtn.addEventListener('click', ()=> flip(-1));
    nextBtn.addEventListener('click', ()=> flip(1));

    function isFullscreen(){ return !!document.fullscreenElement; }
    async function toggleFullscreen(){
      if (!isFullscreen()) await viewport.requestFullscreen();
      else await document.exitFullscreen();
    }
    function updateFsLabel(){
      fsBtn.textContent = isFullscreen() ? 'Exit ‚õ∂' : '‚õ∂ Fullscreen';
    }
    fsBtn.addEventListener('click', toggleFullscreen);
    document.addEventListener('fullscreenchange', updateFsLabel);

    function updateAudioButtons(){
      if (!bgm) return;
      muteBtn.textContent = bgm.muted ? 'üîä Unmute' : 'üîá Mute';
      pauseBtn.textContent = bgm.paused ? '‚ñ∂Ô∏è Play' : '‚è∏Ô∏è Pause';
    }
    muteBtn.addEventListener('click', ()=>{ bgm.muted = !bgm.muted; updateAudioButtons(); });
    pauseBtn.addEventListener('click', ()=>{
      if (bgm.paused){ bgm.play(); } else { bgm.pause(); }
      updateAudioButtons();
    });

    function init(){
      render();
      updateFsLabel();
      updateAudioButtons();
      viewport.focus({preventScroll:true});
    }
    init();
  </script>
</body>
</html>
